################################################################################
# Plot Exploitable Areas
# Author: Mengqi Zhao
# Email: mengqi.zhao@pnnl.gov
# Last Update: 2022-10
################################################################################

# Load libraries
library(data.table)
library(dplyr)
library(sf)
library(ggnewscale)
library(patchwork)
library(paletteer)

# ------------------------------------------------------------------------------
# Set working directory and data path
# ------------------------------------------------------------------------------

# set paths
output.workflow.dir <- 'zhao-etal_2023_gmd/workflow/outputs'

data <- readRDS(file.path(output.workflow.dir, 'LP_inputs_reservoir_20221222.rds'))
expan_dam <- data$expan_dam
expan_grid <- data$expan_grid
output_expan_basin <- data$output_expan_basin
output <- data$output
rm(data)


work.dir <- 'zhao-etal_2023_gmd/figures' # update correspondingly
setwd(work.dir)
figure.dir <- file.path(work.dir, 'outputs', 'exploitable_zones')

# Load RDS data
world <- readRDS(file.path(dirname(output.workflow.dir), 'data', 'world_basemap_robinson_projection.rds'))

# spatial reference code
# set epsg code 4326: https://spatialreference.org/ref/epsg/wgs-84/
epsg_code <- 4326

#  basin simple feature
basin_sf <- rmap::mapGCAMBasins %>% 
  dplyr::select(basin_id = subRegionAlt,
                basin_name = subRegion,
                geometry) %>% 
  sf::st_transform(epsg_code)

#  basin area
basin_area <- rmap::mapGCAMBasins %>% 
  sf::st_drop_geometry() %>% 
  dplyr::select(basin_name = subRegion, area) %>% 
  dplyr::mutate(basin_area_km2 = as.numeric(area)/10^6) %>% 
  dplyr::select(basin_name, basin_area_km2)

water_area <- expan_dam %>% 
  dplyr::group_by(basin_name) %>% 
  dplyr::summarise(lake_area_km2 = sum(LAKE_AREA_KM2)) %>% 
  dplyr::ungroup()

# ------------------------------------------------------------------------------
# Data Process
# ------------------------------------------------------------------------------

# For plot 1: Existing and Exploitable Zones
# Fraction of excluded area over total basin area
# fraction_expan <- output_expan_basin %>% 
#   dplyr::left_join(basin_area,
#                    by = c('basin_name')) %>% 
#   dplyr::mutate(fraction = (basin_area_km2 - expan_area_km2)/(basin_area_km2))

fraction_expan <- output_expan_basin %>% 
  dplyr::left_join(water_area,
                   by = c('basin_name')) %>% 
  dplyr::mutate(fraction = (lake_area_km2 - expan_area_km2)/(lake_area_km2))

fraction_sf <- basin_sf %>% 
  dplyr::left_join(fraction_expan %>% dplyr::select(basin_id, fraction), 
                   by = 'basin_id')

expan_grid_df <- expan_grid %>% 
  dplyr::select(lon, lat, expan_category) %>% 
  dplyr::rename(value = expan_category) %>% 
  dplyr::mutate(param = 'expan_category')

expan_grid_sf <- sf::st_as_sf(expan_grid_df %>% 
                                dplyr::select(-param) %>% 
                                dplyr::filter(value > 0) %>% 
                                dplyr::mutate(zone = case_when(
                                  value == 1 ~ 'Type 1',
                                  value == 2 ~ 'Type 2',
                                  value == 3 ~ 'Type 3'
                                )), 
                              coords = c('lon', 'lat'),
                              crs = epsg_code)

# For plot 2: Expansion potential in gross volume
expan_vol <- output %>% 
  dplyr::rename(CAP_KM3_EXIST = total_cap_km3,
                CAP_KM3_EXPLO = expan_cap_km3) %>%
  dplyr::mutate(CAP_KM3_POTENTIAL = 
                  dplyr::if_else(CAP_KM3_EXIST > CAP_KM3_EXPLO,
                                 0,
                                 CAP_KM3_EXPLO - CAP_KM3_EXIST)) %>% 
  dplyr::select(basin_id, basin_name, CAP_KM3_POTENTIAL)

# ------------------------------------------------------------------------------
# Plot
# ------------------------------------------------------------------------------

# Plot 1: Existing and Exploitable Zones
breaks <- seq(0, 1, 0.1)

fraction_sf <- fraction_sf %>% 
  dplyr::mutate(fraction_group = cut(fraction, breaks, right = TRUE))

# Plot map with all expansion grids
world +
  ggnewscale::new_scale_fill() +
  ggplot2::geom_sf(data = fraction_sf,
                   ggplot2::aes(fill = fraction_group),
                   color = 'grey30', linetype = 1, lwd = 0.25) +
  ggplot2::scale_fill_manual(
    values = c(rev(paletteer_c("ggthemes::Blue-Green Sequential", length(breaks) - 2)), '#FFFFED'),
    guide = ggplot2::guide_colorsteps(
      barwidth = 20,
      barheight = 0.5,
      frame.colour = 'gray50',
      ticks = TRUE,
      ticks.linewidth = 0.5,
      ticks.colour = 'gray50',
      title = bquote('Ratio of Excluded Area to Water Surface Area within Basin'),
      title.position = "top"
    )) +
  ggnewscale::new_scale_fill() +
  ggplot2::geom_sf(data = expan_grid_sf, ggplot2::aes(fill = zone, color = zone), 
                   size = 0.1, lwd = 0.4, pch = 21, alpha = 1) +
  ggplot2::scale_fill_manual(values = c("Type 1" = '#F94240',
                                        "Type 2" = '#FFFF00',
                                        "Type 3" = '#1A476F')) +
  ggplot2::scale_color_manual(values = c("Type 1" = '#F94240',
                                         "Type 2" = '#FFFF00',
                                         "Type 3" = '#1A476F')) +
  ggplot2::guides(
    fill = ggplot2::guide_legend(
      title = 'Existing and Exploitable Grid Cell Types',
      title.position = 'top',
      override.aes = list(size = 3),
      ncol = 3
    ),
    color = 'none'
  ) +
  ggplot2::coord_sf(crs = "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +type=crs") +
  ggplot2::theme_void() +
  ggplot2::theme(plot.background = ggplot2::element_rect(fill = 'white', color = NA),
                 panel.background = ggplot2::element_rect(fill = 'white', color = NA),
                 legend.position = "bottom",
                 legend.spacing = ggplot2::unit(1.0, 'cm'),
                 legend.margin = ggplot2::margin(t = 10, b = 2),
                 legend.title = ggplot2::element_text(size = 10),
                 legend.text = ggplot2::element_text(angle = 0,
                                                     margin = ggplot2::margin(t = 5)))

ggplot2::ggsave(file.path(figure.dir, 'reservoir_expandable_zones.png'),
                height = 6, width = 10, unit = 'in', dpi = 600)
